#!/usr/bin/env ruby
#
# This script is designed to create packages that will be
# used to install Ceph. The script determines which package
# to create depending on the user's environment (RPM package for
# CentOS 7.1 systems and .deb package for Debian Jesse systems).
#
# In addition, the user can pass optional parameters to select
# which repository and branch to retrieve source from (defaults
# to master branch of HP's repository).
#
# This script is written by Robert Clark and was created on
# Friday May 29 at 2:05PM Central Time
#

require 'getoptlong'

version		=	"0.0.1"	# Current version of the script - use with --version
repository	=	"https://github.com/HP-Scale-out-Storage/ceph"
branch		=	"master"
nodebs		=	false
out_dir		=	"./outputs/"

opts 		= 	GetoptLong.new(
	[ '--help',		'-h', 	GetoptLong::NO_ARGUMENT ],
	[ '--version', 			GetoptLong::NO_ARGUMENT ],
	[ '--branch', 	'-b', 	GetoptLong::REQUIRED_ARGUMENT ],
	[ '--repo', 	'-r',	GetoptLong::REQUIRED_ARGUMENT ],
	[ '--no-debs', 			GetoptLong::NO_ARGUMENT ],
	[ '--output',	'-o',	GetoptLong::REQUIRED_ARGUMENT ]
)

def printusage
	puts "usage: build-ceph-packages [-h|--help] [--version]"
    puts "                           [-b|--branch=<branch-name>] [-r|--repo=<repo-url>]"
    puts "                           [--no-debs] [-o|--output=<path>]"
    puts
    puts "This script builds the Ceph RPM and .deb packages from the specified branch of the specified git repository. On a Debian system, only the .deb packages will be generated. On a RHEL/CentOS system, both the RPM and .deb packages will be built."
    puts
    puts "  -b <branch-name>, --branch=<branch-name>"
    puts "    Use the specified branch of the respository. Default is to use master."
    puts
    puts "  --no-debs"
    puts "    Only generate the RPM packages."
    puts
    puts "  -o <path>, --output <path>"
    puts "    Write the generated packages to the specified path."
    puts
    puts "  -r <repo-url>, --repo=<repo-url>"
    puts "    Use the specified repository. The URL must be the one that git would recognize. If not specified, https://github.com/HP-Scale-out-Storage/ceph will be used."
    puts "  -h, --help      display this help and exit"
    puts "      --version   output version information and exit"
    puts
end

begin
	opts.each do |opt, arg|
		case opt
			# Display the script usage and exit with status 0
			when "--help"
				printusage()

				exit 0

			# Display the current version number of the script and exit with status 0
			when "--version"
				puts "Current version of build-ceph-packages: #{version}"

				exit 0

			# Get the branch as input from the user and store it in the 'branch' variable
			when "--branch"
				branch = arg

			# Get the repository as input from the user and store it in the 'repository' variable
			when "--repo"
				repository = arg

			# User specified to only generate the RPM packages
			when "--no-debs"
				nodebs = true

			# Set the output directory as specified by the user
			when "--output"
				out_dirs = arg	

		end
	end

# Catch exceptions if any - print the usage and exit the script with status 1
rescue
	printusage()

	exit 1

end
			
puts "Hello world!"

exit 0
